name: Update Yakit Version

on:
  schedule:
    # æ¯å¤©æ—©ä¸Š 8 ç‚¹æ£€æŸ¥æ›´æ–°
    - cron: '0 8 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      force_update:
        description: 'Force update even if version is the same'
        required: false
        type: boolean
        default: false

jobs:
  update-yakit:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_TOKEN }}

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'

    - name: Check for new Yakit version
      id: check_version
      run: |
        # é¦–å…ˆå°è¯•ä» GitHub Releases è·å–æœ€æ–°ç‰ˆæœ¬
        echo "Fetching latest version from GitHub Releases..."
        GITHUB_VERSION=$(curl -s "https://api.github.com/repos/yaklang/yakit/releases/latest" | grep '"tag_name"' | sed -E 's/.*"tag_name": "([^"]+)".*/\1/' | sed 's/^v//')

        if [ -n "$GITHUB_VERSION" ] && [ "$GITHUB_VERSION" != "null" ]; then
          LATEST_VERSION="$GITHUB_VERSION"
          echo "âœ… Got version from GitHub: $LATEST_VERSION"
        else
          # å›é€€åˆ°åŸå§‹ URL
          echo "âš ï¸  Failed to get version from GitHub, trying backup URL..."
          LATEST_VERSION=$(curl -s "https://oss-qn.yaklang.com/yak/latest/yakit-version.txt" | tr -d '\n')

          if [ -z "$LATEST_VERSION" ]; then
            echo "âŒ Failed to fetch latest version from both sources"
            exit 1
          fi
          echo "âœ… Got version from backup URL: $LATEST_VERSION"
        fi

        # è¯»å–å½“å‰æœ¬åœ°ç‰ˆæœ¬
        if [ -f "latest-version.txt" ]; then
          CURRENT_VERSION=$(cat latest-version.txt | tr -d '\n')
        else
          CURRENT_VERSION="1.4.4-0912"
        fi

        echo "Current local version: $CURRENT_VERSION"
        echo "Latest remote version: $LATEST_VERSION"
        echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
        echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

        # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
        if [ "$LATEST_VERSION" != "$CURRENT_VERSION" ] || [ "${{ github.event.inputs.force_update }}" = "true" ]; then
          echo "needs_update=true" >> $GITHUB_OUTPUT
          echo "ğŸ”„ Version update needed: $CURRENT_VERSION â†’ $LATEST_VERSION"
        else
          echo "needs_update=false" >> $GITHUB_OUTPUT
          echo "âœ… Already up to date: $CURRENT_VERSION"
        fi

    - name: Update version files
      if: steps.check_version.outputs.needs_update == 'true'
      run: |
        LATEST_VERSION="${{ steps.check_version.outputs.latest_version }}"
        CURRENT_VERSION="${{ steps.check_version.outputs.current_version }}"
        TODAY=$(date +%Y-%m-%d)

        echo "ğŸ”„ Updating version files..."
        echo "   From: $CURRENT_VERSION"
        echo "   To:   $LATEST_VERSION"
        echo "   Date: $TODAY"

        # æ›´æ–° latest-version.txt
        echo "$LATEST_VERSION" > latest-version.txt
        echo "âœ… Updated latest-version.txt"

        # æ›´æ–° history-versions.txt
        if [ -f "history-versions.txt" ]; then
          # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥ç‰ˆæœ¬è®°å½•
          if ! grep -q "^$LATEST_VERSION|" history-versions.txt; then
            # æ·»åŠ æ–°ç‰ˆæœ¬åˆ°å†å²è®°å½•
            echo "$LATEST_VERSION|$TODAY|github-auto-update" >> history-versions.txt
            echo "âœ… Added $LATEST_VERSION to history"
          else
            echo "â„¹ï¸  Version $LATEST_VERSION already exists in history"
          fi
        else
          # åˆ›å»ºå†å²æ–‡ä»¶
          echo "# Yakit Version History" > history-versions.txt
          echo "# Format: version|date|source" >> history-versions.txt
          echo "# Data sourced from: https://github.com/yaklang/yakit/releases" >> history-versions.txt
          echo "$LATEST_VERSION|$TODAY|github-auto-update" >> history-versions.txt
          echo "âœ… Created history-versions.txt"
        fi

        # æ˜¾ç¤ºæ›´æ–°åçš„æ–‡ä»¶å†…å®¹
        echo ""
        echo "ğŸ“„ Current latest-version.txt:"
        cat latest-version.txt
        echo ""
        echo "ğŸ“š Recent history-versions.txt entries:"
        tail -3 history-versions.txt

        echo ""
        echo "ğŸ‰ Version files updated successfully!"

    - name: Validate cask syntax
      if: steps.check_version.outputs.needs_update == 'true'
      run: |
        # å®‰è£… homebrew (åœ¨ Ubuntu ä¸Š)
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

        # æ·»åŠ  Homebrew åˆ° PATH
        echo "/home/linuxbrew/.linuxbrew/bin" >> $GITHUB_PATH

        # éªŒè¯ cask è¯­æ³•
        brew cask audit Casks/yakit.rb

    - name: Commit and push changes
      if: steps.check_version.outputs.needs_update == 'true'
      run: |
        LATEST_VERSION="${{ steps.check_version.outputs.latest_version }}"
        CURRENT_VERSION="${{ steps.check_version.outputs.current_version }}"

        # é…ç½® git
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

        # æ·»åŠ æ–‡ä»¶åˆ° git
        git add latest-version.txt history-versions.txt

        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git diff --staged --quiet; then
          echo "No changes to commit"
          exit 0
        fi

        # æäº¤æ›´æ”¹
        git commit -m "chore: update Yakit to version $LATEST_VERSION - auto-generated"

        # æ¨é€åˆ°ä¸»åˆ†æ”¯
        git push origin main

        echo "âœ… Successfully updated Yakit to version $LATEST_VERSION"

    - name: Notify on failure
      if: failure()
      run: |
        echo "âŒ Yakit update workflow failed"
        echo "Please check the workflow logs for details"