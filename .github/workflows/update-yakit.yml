name: Update Yakit Version

on:
  schedule:
    # ÊØèÂ§©Êó©‰∏ä 8 ÁÇπÊ£ÄÊü•Êõ¥Êñ∞
    - cron: '0 8 * * *'
  workflow_dispatch: # ÂÖÅËÆ∏ÊâãÂä®Ëß¶Âèë
    inputs:
      force_update:
        description: 'Force update even if version is the same'
        required: false
        type: boolean
        default: false

jobs:
  update-yakit:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_TOKEN }}

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'

    - name: Check for new Yakit version
      id: check_version
      run: |
        # È¶ñÂÖàÂ∞ùËØï‰ªé GitHub Releases Ëé∑ÂèñÊúÄÊñ∞ÁâàÊú¨
        echo "Fetching latest version from GitHub Releases..."
        GITHUB_VERSION=$(curl -s "https://api.github.com/repos/yaklang/yakit/releases/latest" | grep '"tag_name"' | sed -E 's/.*"tag_name": "([^"]+)".*/\1/' | sed 's/^v//')

        if [ -n "$GITHUB_VERSION" ] && [ "$GITHUB_VERSION" != "null" ]; then
          LATEST_VERSION="$GITHUB_VERSION"
          echo "‚úÖ Got version from GitHub: $LATEST_VERSION"
        else
          # ÂõûÈÄÄÂà∞ÂéüÂßã URL
          echo "‚ö†Ô∏è  Failed to get version from GitHub, trying backup URL..."
          LATEST_VERSION=$(curl -s "https://oss-qn.yaklang.com/yak/latest/yakit-version.txt" | tr -d '\n')

          if [ -z "$LATEST_VERSION" ]; then
            echo "‚ùå Failed to fetch latest version from both sources"
            exit 1
          fi
          echo "‚úÖ Got version from backup URL: $LATEST_VERSION"
        fi

        # ËØªÂèñÂΩìÂâçÊú¨Âú∞ÁâàÊú¨
        if [ -f "latest-version.txt" ]; then
          CURRENT_VERSION=$(cat latest-version.txt | tr -d '\n')
        else
          CURRENT_VERSION="1.4.4-0912"
        fi

        echo "Current local version: $CURRENT_VERSION"
        echo "Latest remote version: $LATEST_VERSION"
        echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
        echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

        # Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊõ¥Êñ∞
        if [ "$LATEST_VERSION" != "$CURRENT_VERSION" ] || [ "${{ github.event.inputs.force_update }}" = "true" ]; then
          echo "needs_update=true" >> $GITHUB_OUTPUT
          echo "üîÑ Version update needed: $CURRENT_VERSION ‚Üí $LATEST_VERSION"
        else
          echo "needs_update=false" >> $GITHUB_OUTPUT
          echo "‚úÖ Already up to date: $CURRENT_VERSION"
        fi

    - name: Update version files
      if: steps.check_version.outputs.needs_update == 'true'
      run: |
        LATEST_VERSION="${{ steps.check_version.outputs.latest_version }}"
        CURRENT_VERSION="${{ steps.check_version.outputs.current_version }}"
        TODAY=$(date +%Y-%m-%d)

        echo "üîÑ Updating version files..."
        echo "   From: $CURRENT_VERSION"
        echo "   To:   $LATEST_VERSION"
        echo "   Date: $TODAY"

        # Êõ¥Êñ∞ latest-version.txt
        echo "$LATEST_VERSION" > latest-version.txt
        echo "‚úÖ Updated latest-version.txt"

        # Êõ¥Êñ∞ history-versions.txt
        if [ -f "history-versions.txt" ]; then
          # Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®ËØ•ÁâàÊú¨ËÆ∞ÂΩï
          if ! grep -q "^$LATEST_VERSION|" history-versions.txt; then
            # Ê∑ªÂä†Êñ∞ÁâàÊú¨Âà∞ÂéÜÂè≤ËÆ∞ÂΩï
            echo "$LATEST_VERSION|$TODAY|github-auto-update" >> history-versions.txt
            echo "‚úÖ Added $LATEST_VERSION to history"
          else
            echo "‚ÑπÔ∏è  Version $LATEST_VERSION already exists in history"
          fi
        else
          # ÂàõÂª∫ÂéÜÂè≤Êñá‰ª∂
          echo "# Yakit Version History" > history-versions.txt
          echo "# Format: version|date|source" >> history-versions.txt
          echo "# Data sourced from: https://github.com/yaklang/yakit/releases" >> history-versions.txt
          echo "$LATEST_VERSION|$TODAY|github-auto-update" >> history-versions.txt
          echo "‚úÖ Created history-versions.txt"
        fi

        # ÊòæÁ§∫Êõ¥Êñ∞ÂêéÁöÑÊñá‰ª∂ÂÜÖÂÆπ
        echo ""
        echo "üìÑ Current latest-version.txt:"
        cat latest-version.txt
        echo ""
        echo "üìö Recent history-versions.txt entries:"
        tail -3 history-versions.txt

        # Êõ¥Êñ∞‰∏äÊ∏∏ cask Êñá‰ª∂ÁâàÊú¨
        echo "üìù Updating upstream cask file..."
        sed -i.bak "s/version \"[^\"]*\"/version \"$LATEST_VERSION\"/" Casks/yakit-upstream.rb
        rm -f Casks/yakit-upstream.rb.bak
        echo "‚úÖ Updated yakit-upstream.rb"

        # ÂàõÂª∫ÁâàÊú¨ÂåñÁöÑ cask Êñá‰ª∂
        echo "üìù Creating versioned cask file..."
        # ÊèêÂèñÁâàÊú¨Âè∑ÈÉ®ÂàÜÔºà1.4.4-0912 -> 1.4.4ÔºâÂíåÊó•ÊúüÈÉ®ÂàÜÔºà0912Ôºâ
        VERSION_PART=$(echo "$LATEST_VERSION" | cut -d'-' -f1)
        DATE_PART=$(echo "$LATEST_VERSION" | cut -d'-' -f2)
        
        # ‰ΩøÁî®ÂÆåÊï¥ÁâàÊú¨Âè∑ÔºàÂåÖÂê´Êó•ÊúüÔºâ‰Ωú‰∏∫ cask ÂêçÁß∞
        VERSIONED_CASK="Casks/yakit@$LATEST_VERSION.rb"
        
        # Ê†ºÂºèÂåñÊó•ÊúüÊòæÁ§∫Ôºà0912 -> 2025-09-12Ôºâ
        YEAR="2025"
        MONTH="${DATE_PART:0:2}"
        DAY="${DATE_PART:2:2}"
        FORMATTED_DATE="$YEAR-$MONTH-$DAY"
        
        # Ê£ÄÊü•ÁâàÊú¨Âåñ cask ÊòØÂê¶Â∑≤Â≠òÂú®
        if [ ! -f "$VERSIONED_CASK" ]; then
          echo "Creating new versioned cask: $VERSIONED_CASK"
          
          # ÂàõÂª∫ÁâàÊú¨Âåñ cask Êñá‰ª∂ÂÜÖÂÆπ
          echo "cask \"yakit@$LATEST_VERSION\" do" > "$VERSIONED_CASK"
          echo "  version \"$LATEST_VERSION\"" >> "$VERSIONED_CASK"
          echo "  sha256 :no_check" >> "$VERSIONED_CASK"
          echo "" >> "$VERSIONED_CASK"
          echo "  name \"Yakit\"" >> "$VERSIONED_CASK"
          echo "  desc \"Cyber Security ALL-IN-ONE Platform (Release Date: $FORMATTED_DATE)\"" >> "$VERSIONED_CASK"
          echo "  homepage \"https://github.com/yaklang/yakit\"" >> "$VERSIONED_CASK"
          echo "" >> "$VERSIONED_CASK"
          echo "  # Ê†πÊçÆÊû∂ÊûÑÈÄâÊã©‰∏çÂêåÁöÑ‰∏ãËΩΩ URL" >> "$VERSIONED_CASK"
          echo "  on_arm do" >> "$VERSIONED_CASK"
          echo "    url \"https://oss-qn.yaklang.com/yak/#{version}/Yakit-#{version}-darwin-arm64.dmg\"" >> "$VERSIONED_CASK"
          echo "  end" >> "$VERSIONED_CASK"
          echo "" >> "$VERSIONED_CASK"
          echo "  on_intel do" >> "$VERSIONED_CASK"
          echo "    url \"https://oss-qn.yaklang.com/yak/#{version}/Yakit-#{version}-darwin-x64.dmg\"" >> "$VERSIONED_CASK"
          echo "  end" >> "$VERSIONED_CASK"
          echo "" >> "$VERSIONED_CASK"
          echo "  app \"Yakit.app\"" >> "$VERSIONED_CASK"
          echo "" >> "$VERSIONED_CASK"
          echo "  zap trash: [" >> "$VERSIONED_CASK"
          echo "    \"~/Library/Application Support/yakit\"," >> "$VERSIONED_CASK"
          echo "    \"~/Library/Preferences/com.yaklang.yakit.plist\"," >> "$VERSIONED_CASK"
          echo "    \"~/Library/Saved Application State/com.yaklang.yakit.savedState\"," >> "$VERSIONED_CASK"
          echo "  ]" >> "$VERSIONED_CASK"
          echo "" >> "$VERSIONED_CASK"
          echo "  caveats do" >> "$VERSIONED_CASK"
          echo "    <<~EOS" >> "$VERSIONED_CASK"
          echo "      This is Yakit version #{version} (Released: $FORMATTED_DATE)." >> "$VERSIONED_CASK"
          echo "      For the latest version, use: brew install yaklang/yakit" >> "$VERSIONED_CASK"
          echo "      " >> "$VERSIONED_CASK"
          echo "      Note: Only one version of Yakit can be installed at a time." >> "$VERSIONED_CASK"
          echo "      To switch versions, uninstall the current version first:" >> "$VERSIONED_CASK"
          echo "        brew uninstall --cask yakit" >> "$VERSIONED_CASK"
          echo "    EOS" >> "$VERSIONED_CASK"
          echo "  end" >> "$VERSIONED_CASK"
          echo "end" >> "$VERSIONED_CASK"
          echo "‚úÖ Created $VERSIONED_CASK"
        else
          echo "‚ÑπÔ∏è  Versioned cask already exists: $VERSIONED_CASK"
        fi

        echo ""
        echo "üéâ Version files updated successfully!"

    - name: Test and validate cask
      if: steps.check_version.outputs.needs_update == 'true'
      run: |
        echo "üîç Testing cask installation and validation..."
        
        # È™åËØÅ Ruby ËØ≠Ê≥ï
        echo "üìã Validating Ruby syntax..."
        if ruby -c Casks/yakit.rb >/dev/null 2>&1; then
          echo "‚úÖ Ruby syntax is valid"
        else
          echo "‚ùå Ruby syntax error detected"
          exit 1
        fi
        
        # È™åËØÅÁâàÊú¨Âåñ cask ÁöÑ Ruby ËØ≠Ê≥ï
        LATEST_VERSION="${{ steps.check_version.outputs.latest_version }}"
        VERSIONED_CASK="Casks/yakit@$LATEST_VERSION.rb"
        if [ -f "$VERSIONED_CASK" ]; then
          echo "üìã Validating versioned cask Ruby syntax..."
          if ruby -c "$VERSIONED_CASK" >/dev/null 2>&1; then
            echo "‚úÖ Versioned cask Ruby syntax is valid"
          else
            echo "‚ùå Versioned cask Ruby syntax error detected"
            exit 1
          fi
        fi
        
        # Ê£ÄÊü•‰∏ãËΩΩ URL ÁöÑÂèØÁî®ÊÄß
        echo "üåê Testing download URLs..."
        LATEST_VERSION="${{ steps.check_version.outputs.latest_version }}"
        ARM64_URL="https://oss-qn.yaklang.com/yak/$LATEST_VERSION/Yakit-$LATEST_VERSION-darwin-arm64.dmg"
        X64_URL="https://oss-qn.yaklang.com/yak/$LATEST_VERSION/Yakit-$LATEST_VERSION-darwin-x64.dmg"
        
        if curl -I "$ARM64_URL" >/dev/null 2>&1; then
          echo "‚úÖ ARM64 download URL is accessible"
        else
          echo "‚ö†Ô∏è  ARM64 download URL may not be accessible"
        fi
        
        if curl -I "$X64_URL" >/dev/null 2>&1; then
          echo "‚úÖ x64 download URL is accessible"
        else
          echo "‚ö†Ô∏è  x64 download URL may not be accessible"
        fi
        
        # ÊµãËØïÂü∫Êú¨ cask ÂÆâË£ÖÔºà‰ΩøÁî®Áõ¥Êé•Êñá‰ª∂Ë∑ØÂæÑÔºâ
        echo "üß™ Testing local cask installation..."
        if brew install --cask ./Casks/yakit.rb --dry-run 2>/dev/null; then
          echo "‚úÖ Dry-run successful"
          
          # Ê≥®ÊÑèÔºöÂú® CI ÁéØÂ¢É‰∏≠ÂÆûÈôÖÂÆâË£ÖÂèØËÉΩÂõ†‰∏∫‰∏ãËΩΩÊó∂Èó¥ËøáÈïøËÄåÂ§±Ë¥•
          # ÊâÄ‰ª•Êàë‰ª¨‰∏ªË¶Å‰æùËµñ dry-run ÂíåËØ≠Ê≥ïÊ£ÄÊü•
          echo "‚ÑπÔ∏è  Skipping actual installation in CI (dry-run passed)"
        else
          echo "‚ö†Ô∏è  Dry-run failed, but this may be due to CI environment limitations"
          echo "‚ÑπÔ∏è  Ruby syntax validation passed, so cask structure is likely correct"
        fi

    - name: Commit and push changes
      if: steps.check_version.outputs.needs_update == 'true'
      run: |
        LATEST_VERSION="${{ steps.check_version.outputs.latest_version }}"
        CURRENT_VERSION="${{ steps.check_version.outputs.current_version }}"

        # ÈÖçÁΩÆ git
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

        # Ê∑ªÂä†Êñá‰ª∂Âà∞ git
        git add latest-version.txt history-versions.txt Casks/yakit-upstream.rb Casks/yakit@*.rb

        # Ê£ÄÊü•ÊòØÂê¶ÊúâÊõ¥Êîπ
        if git diff --staged --quiet; then
          echo "No changes to commit"
          exit 0
        fi

        # Êèê‰∫§Êõ¥Êîπ
        git commit -m "chore: update Yakit to version $LATEST_VERSION - auto-generated"

        # Êé®ÈÄÅÂà∞‰∏ªÂàÜÊîØ
        git push origin main

        echo "‚úÖ Successfully updated Yakit to version $LATEST_VERSION"

    - name: Create PR to homebrew-cask (if needed)
      if: steps.check_version.outputs.needs_update == 'true'
      run: |
        LATEST_VERSION="${{ steps.check_version.outputs.latest_version }}"
        
        echo "üç∫ Preparing PR to homebrew-cask..."
        
        # ÂÖãÈöÜ homebrew-cask ‰ªìÂ∫ì
        git clone https://github.com/Homebrew/homebrew-cask.git homebrew-cask-repo
        cd homebrew-cask-repo
        
        # ÈÖçÁΩÆ git
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # ÂàõÂª∫Êñ∞ÂàÜÊîØ
        BRANCH_NAME="update-yakit-$LATEST_VERSION"
        git checkout -b "$BRANCH_NAME"
        
        # Â§çÂà∂Ê†áÂáÜÁâàÊú¨ÁöÑ cask Êñá‰ª∂Âà∞ homebrew-cask
        cp ../Casks/yakit-upstream.rb Casks/yakit.rb
        
        # È™åËØÅÂú® homebrew-cask ÁéØÂ¢É‰∏≠ÁöÑËØ≠Ê≥ï
        echo "üìã Validating cask in homebrew-cask environment..."
        AUDIT_SUCCESS=false
        
        if brew audit --cask --strict yakit 2>/dev/null; then
          echo "‚úÖ Strict audit passed"
          AUDIT_SUCCESS=true
        else
          echo "‚ö†Ô∏è  Strict audit failed, trying basic audit..."
          if brew audit --cask yakit 2>/dev/null; then
            echo "‚úÖ Basic audit passed"
            AUDIT_SUCCESS=true
          else
            echo "‚ùå Both strict and basic audit failed"
            AUDIT_SUCCESS=false
          fi
        fi
        
        if [ "$AUDIT_SUCCESS" = "true" ]; then
          echo "‚úÖ Cask validation successful in homebrew-cask"
          
          # Êèê‰∫§Êõ¥Êîπ
          git add Casks/yakit.rb
          git commit -m "yakit: update to $LATEST_VERSION" -m "Automatic architecture detection (ARM64/Intel)" -m "Verified installation on macOS"
          
          echo "üìù Changes committed to branch $BRANCH_NAME"
          echo "üîÑ Ready for PR creation to homebrew-cask"
          echo ""
          echo "Manual steps to complete:"
          echo "1. Push branch to your homebrew-cask fork"
          echo "2. Create PR from your fork to Homebrew/homebrew-cask"
          echo "3. Follow homebrew-cask contribution guidelines"
          
        else
          echo "‚ùå Cask validation failed in homebrew-cask environment"
          exit 1
        fi

    - name: Notify on failure
      if: failure()
      run: |
        echo "‚ùå Yakit update workflow failed"
        echo "Please check the workflow logs for details"
        echo ""
        echo "Common issues to check:"
        echo "- Network connectivity to GitHub API"
        echo "- Cask syntax validation"
        echo "- Download URL availability"
        echo "- File permissions and git configuration"