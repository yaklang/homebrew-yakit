name: Update Yakit Version

on:
  schedule:
    # æ¯å¤©æ—©ä¸Š 8 ç‚¹æ£€æŸ¥æ›´æ–°
    - cron: '0 8 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      force_update:
        description: 'Force update even if version is the same'
        required: false
        type: boolean
        default: false

jobs:
  update-yakit:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_TOKEN }}

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'

    - name: Check for new Yakit version
      id: check_version
      run: |
        # é¦–å…ˆå°è¯•ä» GitHub Releases è·å–æœ€æ–°ç‰ˆæœ¬
        echo "Fetching latest version from GitHub Releases..."
        GITHUB_VERSION=$(curl -s "https://api.github.com/repos/yaklang/yakit/releases/latest" | grep '"tag_name"' | sed -E 's/.*"tag_name": "([^"]+)".*/\1/' | sed 's/^v//')

        if [ -n "$GITHUB_VERSION" ] && [ "$GITHUB_VERSION" != "null" ]; then
          LATEST_VERSION="$GITHUB_VERSION"
          echo "âœ… Got version from GitHub: $LATEST_VERSION"
        else
          # å›é€€åˆ°åŸå§‹ URL
          echo "âš ï¸  Failed to get version from GitHub, trying backup URL..."
          LATEST_VERSION=$(curl -s "https://oss-qn.yaklang.com/yak/latest/yakit-version.txt" | tr -d '\n')

          if [ -z "$LATEST_VERSION" ]; then
            echo "âŒ Failed to fetch latest version from both sources"
            exit 1
          fi
          echo "âœ… Got version from backup URL: $LATEST_VERSION"
        fi

        # è¯»å–å½“å‰æœ¬åœ°ç‰ˆæœ¬
        if [ -f "latest-version.txt" ]; then
          CURRENT_VERSION=$(cat latest-version.txt | tr -d '\n')
        else
          CURRENT_VERSION="1.4.4-0912"
        fi

        echo "Current local version: $CURRENT_VERSION"
        echo "Latest remote version: $LATEST_VERSION"
        echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
        echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

        # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
        if [ "$LATEST_VERSION" != "$CURRENT_VERSION" ] || [ "${{ github.event.inputs.force_update }}" = "true" ]; then
          echo "needs_update=true" >> $GITHUB_OUTPUT
          echo "ğŸ”„ Version update needed: $CURRENT_VERSION â†’ $LATEST_VERSION"
        else
          echo "needs_update=false" >> $GITHUB_OUTPUT
          echo "âœ… Already up to date: $CURRENT_VERSION"
        fi

    - name: Update version files
      if: steps.check_version.outputs.needs_update == 'true'
      run: |
        LATEST_VERSION="${{ steps.check_version.outputs.latest_version }}"
        CURRENT_VERSION="${{ steps.check_version.outputs.current_version }}"
        TODAY=$(date +%Y-%m-%d)

        echo "ğŸ”„ Updating version files..."
        echo "   From: $CURRENT_VERSION"
        echo "   To:   $LATEST_VERSION"
        echo "   Date: $TODAY"

        # æ›´æ–° latest-version.txt
        echo "$LATEST_VERSION" > latest-version.txt
        echo "âœ… Updated latest-version.txt"

        # æ›´æ–° history-versions.txt
        if [ -f "history-versions.txt" ]; then
          # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥ç‰ˆæœ¬è®°å½•
          if ! grep -q "^$LATEST_VERSION|" history-versions.txt; then
            # æ·»åŠ æ–°ç‰ˆæœ¬åˆ°å†å²è®°å½•
            echo "$LATEST_VERSION|$TODAY|github-auto-update" >> history-versions.txt
            echo "âœ… Added $LATEST_VERSION to history"
          else
            echo "â„¹ï¸  Version $LATEST_VERSION already exists in history"
          fi
        else
          # åˆ›å»ºå†å²æ–‡ä»¶
          echo "# Yakit Version History" > history-versions.txt
          echo "# Format: version|date|source" >> history-versions.txt
          echo "# Data sourced from: https://github.com/yaklang/yakit/releases" >> history-versions.txt
          echo "$LATEST_VERSION|$TODAY|github-auto-update" >> history-versions.txt
          echo "âœ… Created history-versions.txt"
        fi

        # æ˜¾ç¤ºæ›´æ–°åçš„æ–‡ä»¶å†…å®¹
        echo ""
        echo "ğŸ“„ Current latest-version.txt:"
        cat latest-version.txt
        echo ""
        echo "ğŸ“š Recent history-versions.txt entries:"
        tail -3 history-versions.txt

        # æ›´æ–°ä¸Šæ¸¸ cask æ–‡ä»¶ç‰ˆæœ¬
        echo "ğŸ“ Updating upstream cask file..."
        sed -i.bak "s/version \"[^\"]*\"/version \"$LATEST_VERSION\"/" Casks/yakit-upstream.rb
        rm -f Casks/yakit-upstream.rb.bak
        echo "âœ… Updated yakit-upstream.rb"

        echo ""
        echo "ğŸ‰ Version files updated successfully!"

    - name: Test and validate cask
      if: steps.check_version.outputs.needs_update == 'true'
      run: |
        echo "ğŸ” Testing cask installation and validation..."
        
        # éªŒè¯ cask è¯­æ³•
        echo "ğŸ“‹ Validating cask syntax..."
        brew audit --cask --strict Casks/yakit.rb
        
        # æµ‹è¯•æœ¬åœ° cask å®‰è£…
        echo "ğŸ§ª Testing local cask installation..."
        brew install --cask ./Casks/yakit.rb --dry-run
        
        # å¦‚æœ dry-run æˆåŠŸï¼Œè¿›è¡Œå®é™…å®‰è£…æµ‹è¯•
        if [ $? -eq 0 ]; then
          echo "âœ… Dry-run successful, attempting real installation..."
          brew install --cask ./Casks/yakit.rb
          
          # éªŒè¯å®‰è£…æ˜¯å¦æˆåŠŸ
          if [ -d "/Applications/Yakit.app" ]; then
            echo "âœ… Yakit.app successfully installed to /Applications/"
            
            # æ¸…ç†æµ‹è¯•å®‰è£…
            echo "ğŸ§¹ Cleaning up test installation..."
            brew uninstall --cask yakit || true
          else
            echo "âŒ Installation failed: Yakit.app not found in /Applications/"
            exit 1
          fi
        else
          echo "âŒ Dry-run failed"
          exit 1
        fi

    - name: Commit and push changes
      if: steps.check_version.outputs.needs_update == 'true'
      run: |
        LATEST_VERSION="${{ steps.check_version.outputs.latest_version }}"
        CURRENT_VERSION="${{ steps.check_version.outputs.current_version }}"

        # é…ç½® git
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

        # æ·»åŠ æ–‡ä»¶åˆ° git
        git add latest-version.txt history-versions.txt Casks/yakit-upstream.rb

        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git diff --staged --quiet; then
          echo "No changes to commit"
          exit 0
        fi

        # æäº¤æ›´æ”¹
        git commit -m "chore: update Yakit to version $LATEST_VERSION - auto-generated"

        # æ¨é€åˆ°ä¸»åˆ†æ”¯
        git push origin main

        echo "âœ… Successfully updated Yakit to version $LATEST_VERSION"

    - name: Create PR to homebrew-cask (if needed)
      if: steps.check_version.outputs.needs_update == 'true'
      run: |
        LATEST_VERSION="${{ steps.check_version.outputs.latest_version }}"
        
        echo "ğŸº Preparing PR to homebrew-cask..."
        
        # å…‹éš† homebrew-cask ä»“åº“
        git clone https://github.com/Homebrew/homebrew-cask.git homebrew-cask-repo
        cd homebrew-cask-repo
        
        # é…ç½® git
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # åˆ›å»ºæ–°åˆ†æ”¯
        BRANCH_NAME="update-yakit-$LATEST_VERSION"
        git checkout -b "$BRANCH_NAME"
        
        # å¤åˆ¶æ ‡å‡†ç‰ˆæœ¬çš„ cask æ–‡ä»¶åˆ° homebrew-cask
        cp ../Casks/yakit-upstream.rb Casks/yakit.rb
        
        # éªŒè¯åœ¨ homebrew-cask ç¯å¢ƒä¸­çš„è¯­æ³•
        echo "ğŸ“‹ Validating cask in homebrew-cask environment..."
        brew audit --cask --strict Casks/yakit.rb
        
        if [ $? -eq 0 ]; then
          echo "âœ… Cask validation successful in homebrew-cask"
          
          # æäº¤æ›´æ”¹
          git add Casks/yakit.rb
          git commit -m "yakit: update to $LATEST_VERSION" -m "Automatic architecture detection (ARM64/Intel)" -m "Verified installation on macOS"
          
          echo "ğŸ“ Changes committed to branch $BRANCH_NAME"
          echo "ğŸ”„ Ready for PR creation to homebrew-cask"
          echo ""
          echo "Manual steps to complete:"
          echo "1. Push branch to your homebrew-cask fork"
          echo "2. Create PR from your fork to Homebrew/homebrew-cask"
          echo "3. Follow homebrew-cask contribution guidelines"
          
        else
          echo "âŒ Cask validation failed in homebrew-cask environment"
          exit 1
        fi

    - name: Notify on failure
      if: failure()
      run: |
        echo "âŒ Yakit update workflow failed"
        echo "Please check the workflow logs for details"
        echo ""
        echo "Common issues to check:"
        echo "- Network connectivity to GitHub API"
        echo "- Cask syntax validation"
        echo "- Download URL availability"
        echo "- File permissions and git configuration"